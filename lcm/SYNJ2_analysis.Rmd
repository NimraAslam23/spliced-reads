---
title: "SYNJ2_analysis"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(repurrrsive)
library(jsonlite)
library(clipr)
library(naniar)
library(ggpubr)
library(rstatix)
library(ggplot2)
library(tidyr)
library(dplyr)
library(knitr)
library(snapcount)
library(ggsignif)
```

# Querying for cryptic and annotated SYNJ2 reads

gene_name = "SYNJ2" 
snapcount_coords_cryptic = "chr6:158017291-158019983"
snapcount_coords_annotated = "chr6:158017291-158028755"
strand_code = "+"

```{r querying for cryptic and annotated SYNJ2 reads}
SYNJ2_cryptic_query <- count_query(gene_name = "SYNJ2", snapcount_coords = "chr6:158017291-158019983", strand_code = "+")
SYNJ2_anno_query <- count_query(gene_name = "SYNJ2", snapcount_coords = "chr6:158017291-158028755", strand_code = "+")
```

```{r join cryptic and anno df, add jir column}

SYNJ2_cryptic_query <- SYNJ2_cryptic_query |> rename("cryptic_count" = "count")
SYNJ2_anno_query <- SYNJ2_anno_query |> rename("anno_count" = "count")

SYNJ2_query <- SYNJ2_cryptic_query |> 
  select(gdc_cases.submitter_id, cryptic_count) |> 
  left_join(SYNJ2_anno_query, by = "gdc_cases.submitter_id")

SYNJ2_query <- SYNJ2_query |> 
  relocate(cryptic_count, .after = anno_count)

SYNJ2_query <- SYNJ2_query |> 
  mutate(jir = anno_count/(anno_count + cryptic_count)) |> 
  relocate(jir, .after = cryptic_count)

#write_clip(SYNJ2_query$gdc_cases.submitter_id)
```

```{r clinical data from TCGA (case set)}
SYNJ2_clinical_orig <- read.csv("SYNJ2_clinical.tsv", sep = "\t", header = TRUE,
                                   na.strings = "", fill = TRUE)

SYNJ2_clinical <- SYNJ2_clinical_orig

SYNJ2_clinical <- SYNJ2_clinical|> 
  select(case_submitter_id, project_id, age_at_index, ethnicity, gender, race, ajcc_pathologic_stage) |> 
  separate(project_id, into = c("project", "cancer_type")) |> 
  select(-project)
```

```{r bar plot - cancer types with SYNJ2 events}

SYNJ2_clinical |> 
  ggplot(aes(x = fct_rev(fct_infreq(cancer_type)))) +
  geom_bar() +
  coord_flip() +
  labs(
    x = "Cancer Type",
    y = "Number of Cases",
    title = ""
  ) +
  theme(plot.title = element_text(size=10))
```

```{r join query table with clinical table}

SYNJ2_clinical_jir <- SYNJ2_query |> rename("case_submitter_id" = "gdc_cases.submitter_id") |> 
  left_join(SYNJ2_clinical, by=c("case_submitter_id")) |> 
  select(-gdc_cases.diagnoses.tumor_stage, -age_at_index, -gdc_cases.demographic.gender, 
         -ajcc_pathologic_stage, -ethnicity, -race, -cancer_type, -gender) |> 
  rename("cancer_type" = "gdc_cases.project.name") |> 
  rename("gdc_primary_site" = "gdc_cases.project.primary_site") |> 
  rename("sample_type" = "gdc_cases.samples.sample_type") |> 
  rename("cgc_primary_site" = "cgc_case_primary_site")

SYNJ2_clinical_jir_cryptic <- SYNJ2_clinical_jir |> 
  filter(cryptic_count > 2) 
```

```{r primary sites of cancers with cryptic SYNJ2 events}

SYNJ2_clinical_jir_cryptic |> 
  drop_na() |> 
  ggplot(aes(x = fct_rev(fct_infreq(gdc_primary_site)))) +
  geom_bar() +
  coord_flip() +
  labs(
    x = "Primary Site of Cancer",
    y = "Number of Cases",
    title = ""
  ) +
  theme(plot.title = element_text(size=10))
```

```{r cryptic SYNJ2 expression in different cancer sites}

SYNJ2_clinical_jir_cryptic |> 
  drop_na() |> 
  ggplot(aes(x = cryptic_count,
             y = fct_reorder(gdc_primary_site, cryptic_count, median))) +
  geom_boxplot() +
  labs(
    x = "SYNJ2 Cryptic Coverage",
    y = "Primary Site of Cancer"
  ) +
  theme(plot.title = element_text(size=10))
```

```{r which cancers have the most cryptic SYNJ2 events?}

SYNJ2_events_different_cancers <- SYNJ2_clinical_jir_cryptic |> 
  drop_na() |> 
  janitor::tabyl(cancer_type) |> arrange(-percent)
```

```{r where are the cancers with cryptic SYNJ2 events located?}

SYNJ2_events_primary_sites <- SYNJ2_clinical_jir_cryptic |> 
  drop_na() |> 
  janitor::tabyl(gdc_primary_site) |> arrange(-percent)
```

```{r cBioPortal clinical data, join with SYNJ2 table}

SYNJ2_cryptic_cBio <- SYNJ2_clinical_jir_cryptic |> 
  left_join(cBio_clinical, by = "case_submitter_id") |> 
  select(-cgc_primary_site, -Cancer.Type, -Overall.Survival..Months.) |>
  rename("disease_survival_months" = "Months.of.disease.specific.survival") |> 
  relocate(case_submitter_id, .after = Sample.ID) |> 
  relocate(cancer_type, .after = case_submitter_id) |> 
  relocate(gdc_primary_site, .after = cancer_abbrev) |> 
  relocate(sample_type, .after = gdc_primary_site) |> 
  janitor::clean_names()
```

```{r boxplot - n mutations for each cancer type}

SYNJ2_cryptic_cBio <- SYNJ2_cryptic_cBio |> 
  mutate_at("mutation_count", as.numeric)

SYNJ2_cryptic_cBio |> 
  drop_na() |> 
  filter(mutation_count < 500) |> 
  ggplot(aes(x = fct_reorder(cancer_abbrev, mutation_count, median),
             y = mutation_count)) +
  geom_boxplot() +
  coord_flip() +
  labs(
    x = "Cancer Type",
    y = "Mutation Count"
  ) +
  geom_signif(comparisons = list(c("ESCA", "HNSC")),
map_signif_level = TRUE,
y_position = c(450))
```

```{r cryptic coverage vs mutation count}

SYNJ2_cryptic_cBio |> 
  drop_na() |> 
  filter(mutation_count < 300) |> 
  ggplot(aes(x = as.factor(cryptic_count),
             y = mutation_count)) +
  geom_boxplot() +
  labs(
    x = "Number of SYNJ2 cryptic events",
    y = "Mutation Count"
  ) + 
  geom_signif(comparisons = list(c("8", "9"), c("7","9")),
map_signif_level = TRUE,
y_position = c(230,210))

SYNJ2_cryptic_cBio |> 
  drop_na() |> 
  filter(mutation_count < 500) |> 
  ggplot(aes(x = cryptic_count, 
             y = mutation_count)) +
  geom_hex() +
  labs(
    x = "Number of SYNJ2 cryptic events",
    y = "Mutation Count"
  )
```

